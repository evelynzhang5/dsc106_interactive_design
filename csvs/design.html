<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Carbs vs. Glucose Spike Scatter</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-lasso@1"></script>
  <style>
    body { font-family: sans-serif; }
    #controls { margin: 20px; }
    #scatter { border: 1px solid #ccc; }
    .dot { opacity: 0.8; cursor: pointer; }
    .selected { stroke: black; stroke-width: 1.5px; }
    #tooltip { position: absolute; background: white; border: 1px solid #aaa; padding: 10px; pointer-events: none; opacity: 0; }
    #averageCurve { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="controls">
    <label>Max Carbs: <span id="sliderValue">100</span>g</label>
    <input id="carbSlider" type="range" min="0" max="120" value="100">
    <label>Color by: </label>
    <select id="nutrientSelect">
      <option value="protein">Protein</option>
      <option value="total_fat">Fat</option>
      <option value="total_carb">Fiber</option>
    </select>
  </div>
  <svg id="scatter" width="600" height="400"></svg>
  <div id="tooltip"></div>
  <svg id="averageCurve" width="600" height="200"></svg>

  <script>
    const margin = {top: 20, right: 20, bottom: 40, left: 50};
    const width = 600 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;
    const svg = d3.select('#scatter')
      .append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select('#tooltip');

    Promise.all([
      d3.csv('Food_log_001.csv', d => ({
        id: d.date + ' ' + d.time,
        carbs: +d.total_carb,
        protein: +d.protein,
        total_fat: +d.total_fat,
        time_begin: new Date(d.time_begin)
      })),
      d3.csv('Dexcom_001.csv', d => ({
        timestamp: new Date(d['Timestamp']),
        glucose: +d['Glucose Value (mg/dL)']
      }))
    ]).then(([meals, dexcom]) => {
      // Precompute spike and curve for each meal
      meals.forEach(m => {
        const window = dexcom.filter(pt => pt.timestamp >= m.time_begin && pt.timestamp <= new Date(m.time_begin.getTime() + 2*3600*1000));
        m.curve = window;
        if (window.length) m.spike = d3.max(window, d => d.glucose) - window[0].glucose;
        else m.spike = 0;
      });

      // filter out meals without spike
      meals = meals.filter(d => !isNaN(d.spike));

      const x = d3.scaleLinear().domain([0, d3.max(meals, d=>d.carbs)]).range([0, width]);
      const y = d3.scaleLinear().domain([0, d3.max(meals, d=>d.spike)]).range([height,0]);
      const color = d3.scaleSequential(d3.interpolateViridis).domain(d3.extent(meals, d=>d.protein));

      svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x));
      svg.append('g').call(d3.axisLeft(y));
      svg.append('text').attr('x', width/2).attr('y', height+35).attr('text-anchor','middle').text('Carbs (g)');
      svg.append('text').attr('transform','rotate(-90)').attr('x', -height/2).attr('y', -35).attr('text-anchor','middle').text('2-hr Spike (mg/dL)');

      const dots = svg.append('g').selectAll('.dot')
        .data(meals)
        .enter().append('circle')
        .attr('class','dot')
        .attr('cx', d=>x(d.carbs))
        .attr('cy', d=>y(d.spike))
        .attr('r',5)
        .attr('fill', d=>color(d.protein))
        .on('mouseover', (event,d)=>{
          tooltip.transition().duration(200).style('opacity',.9);
          tooltip.html(`<strong>Carbs:</strong> ${d.carbs}g<br><strong>Spike:</strong> ${d.spike.toFixed(1)}<br>`)
            .style('left', (event.pageX+10)+'px').style('top', (event.pageY-28)+'px');
          // draw mini-curve
          const mini = tooltip.append('svg').attr('width',180).attr('height',80);
          const mx = d3.scaleTime().domain(d3.extent(d.curve, c=>c.timestamp)).range([0,160]);
          const my = d3.scaleLinear().domain(d3.extent(d.curve, c=>c.glucose)).range([60,0]);
          const miniLine = d3.line()
            .x(c=>mx(c.timestamp))
            .y(c=>my(c.glucose));
          mini.append('path').datum(d.curve)
            .attr('d',miniLine).attr('stroke','steelblue').attr('fill','none');
        })
        .on('mouseout', ()=> tooltip.transition().duration(200).style('opacity',0));

      // Slider filter
      d3.select('#carbSlider').on('input', function() {
        const maxC = +this.value;
        d3.select('#sliderValue').text(maxC);
        dots.attr('display', d=> d.carbs <= maxC ? null : 'none');
      });

      // Dropdown recolor
      d3.select('#nutrientSelect').on('change', function() {
        const key = this.value;
        color.domain(d3.extent(meals, d=>d[key]));
        dots.transition().attr('fill', d=>color(d[key]));
      });

      // Lasso selection
      const lasso = d3.lasso()
        .closePathSelect(true).closePathDistance(100)
        .items(dots)
        .targetArea(svg)
        .on('end', selection => {
          const selected = selection.selectedItems().data();
          // highlight
          dots.classed('selected', d=>selected.includes(d));
          // compute avg curve
          const allCurves = d3.merge(selected.map(d=>d.curve));
          if (allCurves.length) drawAvgCurve(allCurves);
        });
      svg.call(lasso);

      function drawAvgCurve(data) {
        const ac = d3.select('#averageCurve').html('').append('g').attr('transform',`translate(${margin.left},10)`);
        const x2 = d3.scaleTime().domain(d3.extent(data, d=>d.timestamp)).range([0,width]);
        const y2 = d3.scaleLinear().domain(d3.extent(data, d=>d.glucose)).range([150,0]);
        ac.append('g').attr('transform',`translate(0,150)`).call(d3.axisBottom(x2).ticks(4));
        ac.append('g').call(d3.axisLeft(y2));
        const avgLine = d3.line()
          .x(d=>x2(d.timestamp))
          .y(d=>y2(d3.mean(data.filter(e=>+e.timestamp===+d.timestamp), e=>e.glucose)));
        // sample timestamps
        const times = [...new Set(data.map(d=>+d.timestamp))].map(t=>new Date(t)).sort((a,b)=>a-b);
        const avgData = times.map(t=>({timestamp:t, glucose:d3.mean(data.filter(e=>+e.timestamp===+t), e=>e.glucose)}));
        ac.append('path').datum(avgData)
          .attr('d',avgLine).attr('stroke','crimson').attr('fill','none').attr('stroke-width',2);
      }
    });
  </script>
</body>
</html>
